worker_processes 4;
worker_rlimit_nofile 40000;

events {
    worker_connections 8192;
}

# local server configuration
http {

    log_format compression   '[$time_local] [remote=$remote_addr] [agent=$remote_user] '
                        '[proto=$request] [status=$status] [sent=$body_bytes_sent] '
                        '[hf=$http_referer] [hua=$http_user_agent] [gzr=$gzip_ratio]';

    access_log  /dev/stdout compression;

    default_type application/json;

    server {
        location / {
            root   /usr/share/nginx/html;
            index  index.php index.html index.htm;
            #return 200 '{\n"status": "ok"\n}';
            #add_header Content-Type application/json;
            add_header Content-Type text/html;
        }
    }
}

# upstream server configuration
stream {
    log_format  upstream_time  '[$time_local] [remote=$remote_addr] '
                             '[proto=$protocol] [status=$status] [sent=$bytes_sent] [rcv=$bytes_received] '
                             '[agent=$upstream_addr] [session-time=$session_time] '
                             '[uct=$upstream_connect_time] [ubs=$upstream_bytes_sent] [ubr=$upstream_bytes_received]';

    access_log  /dev/stdout upstream_time;

    upstream etcd_servers {
        least_conn;
        zone etcd_servers 64k;
        server etcd-00:2379 max_fails=3 fail_timeout=5s;
        server etcd-01:2379 max_fails=3 fail_timeout=5s;
        server etcd-02:2379 max_fails=3 fail_timeout=5s;
    }

    server {
        listen     2379;
        proxy_pass etcd_servers;
        #health_check interval=10 passes=2 fails=3;
    }

    upstream etcd_peer_servers {
        least_conn;
        server etcd-00:2380 max_fails=3 fail_timeout=5s;
        server etcd-01:2380 max_fails=3 fail_timeout=5s;
        server etcd-02:2380 max_fails=3 fail_timeout=5s;
    }

    server {
        listen     2380;
        proxy_pass etcd_peer_servers;
    }

    upstream minio_server_9000 {
        least_conn;
        server minio:9000 max_fails=3 fail_timeout=5s;
    }

    upstream minio_server_9001 {
        least_conn;
        server minio:9001 max_fails=3 fail_timeout=5s;
    }

    server {
        listen     9000;
        proxy_pass minio_server_9000;
    }

    server {
        listen     9001;
        proxy_pass minio_server_9001;
    }

    upstream mysql_server {
        least_conn;
        server mysql:3306 max_fails=3 fail_timeout=5s;
    }

    upstream mysql_server_33060 {
        least_conn;
        server mysql:33060 max_fails=3 fail_timeout=5s;
    }

    upstream mysql_server_33061 {
        least_conn;
        server mysql:33061 max_fails=3 fail_timeout=5s;
    }

    server {
        listen     3306;
        proxy_pass mysql_server;
    }

    server {
        listen     33060;
        proxy_pass mysql_server_33060;
    }

    server {
        listen     33061;
        proxy_pass mysql_server_33061;
    }

    upstream milvus_server {
        least_conn;
        server milvus.example.com:19530 max_fails=3 fail_timeout=5s;
    }

    server {
        listen     19530;
        proxy_pass milvus_server;
    }

    upstream milvus_server_9091 {
        least_conn;
        server milvus.example.com:9091 max_fails=3 fail_timeout=5s;
    }

    server {
        listen     9091;
        proxy_pass milvus_server_9091;
    }

    upstream pulsar_server {
        least_conn;
        server pulsar.example.com:6650 max_fails=3 fail_timeout=5s;
    }

    server {
        listen     6650;
        proxy_pass pulsar_server;
    }

    upstream pulsar_web_port_80 {
        least_conn;
        server pulsar.example.com:80 max_fails=3 fail_timeout=5s;
    }

    server {
        listen     8081;
        proxy_pass pulsar_web_port_80;
    }

    upstream rootcoord_server {
        least_conn;
        server rootcoord.example.com:53100 max_fails=3 fail_timeout=5s;
    }

    server {
        listen     53100;
        proxy_pass rootcoord_server;
    }

    upstream querycoord_server {
        least_conn;
        server querycoord.example.com:19531 max_fails=3 fail_timeout=5s;
    }

    server {
        listen     19531;
        proxy_pass querycoord_server;
    }

    upstream querynode_server {
        least_conn;
        server querynode.example.com:21123 max_fails=3 fail_timeout=5s;
    }

    server {
        listen     21123;
        proxy_pass querynode_server;
    }

    upstream indexcoord_server {
        least_conn;
        server indexcoord.example.com:31000 max_fails=3 fail_timeout=5s;
    }

    server {
        listen     31000;
        proxy_pass indexcoord_server;
    }

    upstream indexnode_server {
        least_conn;
        server indexnode.example.com:21121 max_fails=3 fail_timeout=5s;
    }

    server {
        listen     21121;
        proxy_pass indexnode_server;
    }

    upstream datacoord_server {
        least_conn;
        server datacoord.example.com:13333 max_fails=3 fail_timeout=5s;
    }

    server {
        listen     13333;
        proxy_pass datacoord_server;
    }

    upstream datanode_server {
        least_conn;
        server datanode.example.com:21124 max_fails=3 fail_timeout=5s;
    }

    server {
        listen     21124;
        proxy_pass datanode_server;
    }
}